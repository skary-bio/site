<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blend Cubes üé≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    canvas {
      border: 3px solid #ff3399;
      background: #111;
    }
    .neon-text {
      text-shadow: 0 0 5px #ff3399, 0 0 10px #33ffcc;
    }
    .pulse:hover {
      animation: pulse 0.3s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center">
  <!-- üìã –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –Ω–∏–∫–∞ -->
  <div id="loginScreen" class="text-center">
    <h1 class="text-5xl neon-text my-4">Blend Cubes üé≤</h1>
    <input id="nickname" type="text" placeholder="–í–≤–µ–¥–∏ —Å–≤–æ–π –Ω–∏–∫ üòé" class="p-2 rounded bg-gray-800 text-white border border-pink-500">
    <button id="joinBtn" class="bg-pink-500 hover:bg-pink-700 pulse text-white font-bold py-2 px-4 rounded mt-4">–í–æ–π—Ç–∏ üö™</button>
    <p id="error" class="text-red-500 hidden">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è üò¢</p>
  </div>

  <!-- üéÆ –≠–∫—Ä–∞–Ω –ª–æ–±–±–∏ -->
  <div id="lobbyScreen" class="hidden text-center">
    <h1 class="text-5xl neon-text my-4">–õ–æ–±–±–∏ üïí</h1>
    <p>–û–∂–∏–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤... –ú–∏–Ω–∏–º—É–º 3 üë•</p>
    <p id="playerCount">–ò–≥—Ä–æ–∫–æ–≤: 0</p>
    <p id="countdown" class="text-2xl neon-text"></p>
    <canvas id="lobbyCanvas" width="800" height="600"></canvas>
  </div>

  <!-- üèÉ –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
  <div id="gameScreen" class="hidden text-center">
    <h1 class="text-5xl neon-text my-4">Blend Cubes üé≤</h1>
    <p>–ñ–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: <span id="aliveCount">0</span> üë•</p>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
  </div>

  <script>
    // üé® –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const loginScreen = document.getElementById('loginScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen = document.getElementById('gameScreen');
    const nicknameInput = document.getElementById('nickname');
    const joinBtn = document.getElementById('joinBtn');
    const errorDisplay = document.getElementById('error');
    const playerCount = document.getElementById('playerCount');
    const countdown = document.getElementById('countdown');
    const aliveCount = document.getElementById('aliveCount');
    const lobbyCanvas = document.getElementById('lobbyCanvas');
    const gameCanvas = document.getElementById('gameCanvas');
    const lobbyCtx = lobbyCanvas.getContext('2d');
    const gameCtx = gameCanvas.getContext('2d');

    // üåê Socket.IO
    const socket = io('http://localhost:8080', { transports: ['websocket'] });
    let playerId = null;
    let nickname = '';
    let players = {};
    let gameState = 'login';
    let keys = {};

    // üö™ –í—Ö–æ–¥ –≤ –∏–≥—Ä—É
    joinBtn.addEventListener('click', () => {
      nickname = nicknameInput.value.trim();
      if (nickname) {
        socket.emit('join', { nickname });
        loginScreen.classList.add('hidden');
        lobbyScreen.classList.remove('hidden');
        gameState = 'lobby';
      }
    });

    // üéπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);

    // üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –∫—É–±–∏–∫—É
    gameCanvas.addEventListener('click', (e) => {
      if (gameState === 'game' && players[playerId]?.alive) {
        const rect = gameCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        for (const id in players) {
          if (id !== playerId && players[id].alive) {
            const dx = players[id].x - (x + (players[playerId].x - 400));
            const dy = players[id].y - (y + (players[playerId].y - 300));
            if (Math.hypot(dx, dy) < 20) {
              socket.emit('kill', { targetId: id });
              break;
            }
          }
        }
      }
    });

    // üì° –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    socket.on('init', (data) => {
      playerId = data.playerId;
    });

    socket.on('update', (data) => {
      players = data.players;
      if (gameState === 'lobby') {
        playerCount.textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${Object.keys(players).length}`;
        countdown.textContent = data.countdown ? `–°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑: ${data.countdown} —Å–µ–∫ üïí` : '';
      } else if (gameState === 'game') {
        aliveCount.textContent = Object.values(players).filter(p => p.alive).length;
      }
    });

    socket.on('start', () => {
      lobbyScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');
      gameState = 'game';
      updateGame();
    });

    socket.on('connect_error', () => {
      errorDisplay.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è üò¢ –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä!';
      errorDisplay.classList.remove('hidden');
    });

    // üéÆ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–±–±–∏
    function updateLobby() {
      lobbyCtx.clearRect(0, 0, lobbyCanvas.width, lobbyCanvas.height);
      // üåü –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω
      lobbyCtx.fillStyle = '#111';
      lobbyCtx.fillRect(0, 0, lobbyCanvas.width, lobbyCanvas.height);
      for (let i = 0; i < 50; i++) {
        lobbyCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        lobbyCtx.fillRect(Math.random() * 800, Math.random() * 600, 2, 2);
      }
      for (const id in players) {
        const p = players[id];
        lobbyCtx.fillStyle = p.alive ? '#ff3399' : '#555';
        lobbyCtx.fillRect(p.x, p.y, 20, 20);
        lobbyCtx.fillStyle = 'white';
        lobbyCtx.font = '14px Arial';
        lobbyCtx.fillText(p.nickname, p.x, p.y - 10);
      }
      if (gameState === 'lobby') requestAnimationFrame(updateLobby);
    }

    // üèÉ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
    function updateGame() {
      gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

      // üé• –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ª—è –∑—Ä–µ–Ω–∏—è
      gameCtx.save();
      gameCtx.beginPath();
      gameCtx.arc(400, 300, 100, 0, Math.PI * 2);
      gameCtx.clip();

      // üó∫Ô∏è –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã
      gameCtx.fillStyle = '#222';
      gameCtx.fillRect(0, 0, 1000, 1000);

      // üé≤ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
      const px = players[playerId]?.x || 400;
      const py = players[playerId]?.y || 300;
      for (const id in players) {
        const p = players[id];
        if (p.alive) {
          const drawX = p.x - (px - 400);
          const drawY = p.y - (py - 300);
          gameCtx.fillStyle = '#ff3399';
          gameCtx.fillRect(drawX - 10, drawY - 10, 20, 20);
          gameCtx.fillStyle = 'white';
          gameCtx.font = '14px Arial';
          gameCtx.fillText(p.nickname, drawX - 10, drawY - 20);
        }
      }

      gameCtx.restore();

      // üö∂ –î–≤–∏–∂–µ–Ω–∏–µ
      if (gameState === 'game' && players[playerId]?.alive) {
        let dx = 0, dy = 0;
        if (keys.ArrowUp || keys.w) dy -= 5;
        if (keys.ArrowDown || keys.s) dy += 5;
        if (keys.ArrowLeft || keys.a) dx -= 5;
        if (keys.ArrowRight || keys.d) dx += 5;
        if (dx || dy) {
          socket.emit('move', { dx, dy });
        }
      }

      if (gameState === 'game') requestAnimationFrame(updateGame);
    }

    // üöÄ –°—Ç–∞—Ä—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    socket.on('connect', () => {
      updateLobby();
    });
  </script>
</body>
</html>
