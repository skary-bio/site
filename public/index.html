<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blend Cubes 🎲</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    canvas {
      border: 3px solid #ff3399;
      background: #111;
    }
    .neon-text {
      text-shadow: 0 0 5px #ff3399, 0 0 10px #33ffcc;
    }
    .pulse:hover {
      animation: pulse 0.3s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center">
  <!-- 📋 Экран ввода ника -->
  <div id="loginScreen" class="text-center">
    <h1 class="text-5xl neon-text my-4">Blend Cubes 🎲</h1>
    <input id="nickname" type="text" placeholder="Введи свой ник 😎" class="p-2 rounded bg-gray-800 text-white border border-pink-500">
    <button id="joinBtn" class="bg-pink-500 hover:bg-pink-700 pulse text-white font-bold py-2 px-4 rounded mt-4">Войти 🚪</button>
  </div>

  <!-- 🎮 Экран лобби -->
  <div id="lobbyScreen" class="hidden text-center">
    <h1 class="text-5xl neon-text my-4">Лобби 🕒</h1>
    <p>Ожидаем игроков... Минимум 3 👥</p>
    <p id="playerCount">Игроков: 0</p>
    <p id="countdown" class="text-2xl neon-text"></p>
    <canvas id="lobbyCanvas" width="800" height="600"></canvas>
  </div>

  <!-- 🏃 Экран игры -->
  <div id="gameScreen" class="hidden text-center">
    <h1 class="text-5xl neon-text my-4">Blend Cubes 🎲</h1>
    <p>Живых игроков: <span id="aliveCount">0</span> 👥</p>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
  </div>

  <script>
    // 🎨 Элементы DOM
    const loginScreen = document.getElementById('loginScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen = document.getElementById('gameScreen');
    const nicknameInput = document.getElementById('nickname');
    const joinBtn = document.getElementById('joinBtn');
    const playerCount = document.getElementById('playerCount');
    const countdown = document.getElementById('countdown');
    const aliveCount = document.getElementById('aliveCount');
    const lobbyCanvas = document.getElementById('lobbyCanvas');
    const gameCanvas = document.getElementById('gameCanvas');
    const lobbyCtx = lobbyCanvas.getContext('2d');
    const gameCtx = gameCanvas.getContext('2d');

    // 🌐 WebSocket
    const ws = new WebSocket('ws://localhost:8080');
    let playerId = null;
    let nickname = '';
    let players = {};
    let gameState = 'login';
    let keys = {};

    // 🚪 Вход в игру
    joinBtn.addEventListener('click', () => {
      nickname = nicknameInput.value.trim();
      if (nickname) {
        ws.send(JSON.stringify({ type: 'join', nickname }));
        loginScreen.classList.add('hidden');
        lobbyScreen.classList.remove('hidden');
        gameState = 'lobby';
      }
    });

    // 🎹 Управление
    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);

    // 🖱️ Клик по кубику
    gameCanvas.addEventListener('click  document.addEventListener('click', (e) => {
      if (gameState === 'game') {
        const rect = gameCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        for (const id in players) {
          if (id !== playerId && players[id].alive) {
            const dx = players[id].x - x;
            const dy = players[id].y - y;
            if (Math.hypot(dx, dy) < 20) {
              ws.send(JSON.stringify({ type: 'kill', targetId: id }));
              break;
            }
          }
        }
      }
    });

    // 📡 Обработка сообщений от сервера
    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      switch (msg.type) {
        case 'init':
          playerId = msg.playerId;
          break;
        case 'update':
          players = msg.players;
          if (gameState === 'lobby') {
            playerCount.textContent = `Игроков: ${Object.keys(players).length}`;
            countdown.textContent = msg.countdown ? `Старт через: ${msg.countdown} сек 🕒` : '';
          } else if (gameState === 'game') {
            aliveCount.textContent = Object.values(players).filter(p => p.alive).length;
          }
          break;
        case 'start':
          lobbyScreen.classList.add('hidden');
          gameScreen.classList.remove('hidden');
          gameState = 'game';
          break;
      }
    };

    // 🎮 Обновление лобби
    function updateLobby() {
      lobbyCtx.clearRect(0, 0, lobbyCanvas.width, lobbyCanvas.height);
      for (const id in players) {
        const p = players[id];
        lobbyCtx.fillStyle = p.alive ? '#ff3399' : '#555';
        lobbyCtx.fillRect(p.x, p.y, 20, 20);
        lobbyCtx.fillStyle = 'white';
        lobbyCtx.font = '14px Arial';
        lobbyCtx.fillText(p.nickname, p.x, p.y - 10);
      }
      if (gameState === 'lobby') requestAnimationFrame(updateLobby);
    }

    // 🏃 Обновление игры
    function updateGame() {
      gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

      // 🎥 Ограничение поля зрения
      gameCtx.save();
      gameCtx.beginPath();
      gameCtx.arc(400, 300, 100, 0, Math.PI * 2);
      gameCtx.clip();

      // 🗺️ Отрисовка карты
      gameCtx.fillStyle = '#222';
      gameCtx.fillRect(0, 0, 1000, 1000);

      // 🎲 Отрисовка игроков
      for (const id in players) {
        const p = players[id];
        if (p.alive) {
          gameCtx.fillStyle = '#ff3399';
          gameCtx.fillRect(p.x - 10, p.y - 10, 20, 20);
          gameCtx.fillStyle = 'white';
          gameCtx.font = '14px Arial';
          gameCtx.fillText(p.nickname, p.x - 10, p.y - 20);
        }
      }

      gameCtx.restore();

      // 🚶 Движение
      if (gameState === 'game' && players[playerId]?.alive) {
        let dx = 0, dy = 0;
        if (keys.ArrowUp || keys.w) dy -= 5;
        if (keys.ArrowDown || keys.s) dy += 5;
        if (keys.ArrowLeft || keys.a) dx -= 5;
        if (keys.ArrowRight || keys.d) dx += 5;
        if (dx || dy) {
          ws.send(JSON.stringify({ type: 'move', dx, dy }));
        }
      }

      if (gameState === 'game') requestAnimationFrame(updateGame);
    }

    // 🚀 Старт рендеринга
    ws.onopen = () => {
      updateLobby();
    };
  </script>
</body>
</html>
